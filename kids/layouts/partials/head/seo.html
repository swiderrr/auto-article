{{- $title := .Params.seo.title | default .Title -}}
{{- /* Backwards compatible lookup: seo.description preferred, fall back to seo.meta_description then summary then site description */ -}}
{{- $description := .Params.seo.description | default .Params.seo.meta_description | default .Params.summary | default .Site.Params.description -}}
{{- /* Handle featured image: .Params.featured_image may be a string, but Site.Params.defaultImage
			 in this project is a map (tables). Safely extract a string image path using kindIs and scratch. */ -}}
{{- $imageRaw := .Params.featured_image | default .Site.Params.defaultImage -}}
{{- $scratch := newScratch -}}
{{- if $imageRaw -}}
		{{- if eq (printf "%T" $imageRaw) "string" -}}
			{{- $scratch.Set "image" $imageRaw -}}
	{{- else -}}
		{{- with $imageRaw.article }}
			{{- with .src }}{{- $scratch.Set "image" . -}}{{- end -}}
		{{- end -}}
		{{- if not ($scratch.Get "image") }}
			{{- with $imageRaw.opengraph }}
				{{- with .src }}{{- $scratch.Set "image" . -}}{{- end -}}
			{{- end -}}
		{{- end -}}
	{{- end -}}
{{- end -}}
{{- if not ($scratch.Get "image") }}{{- $scratch.Set "image" .Site.Params.favicon | default "" -}}{{- end -}}
{{- $image := $scratch.Get "image" -}}

<!-- Standard SEO -->
<title>{{ $title }}</title>
<meta name="description" content="{{ $description }}">
<link rel="canonical" href="{{ .Permalink }}">

<!-- Open Graph -->
<meta property="og:title" content="{{ .Params.seo.og.title | default $title }}">
<meta property="og:description" content="{{ .Params.seo.og.description | default $description }}">
<meta property="og:url" content="{{ .Permalink }}">
<meta property="og:site_name" content="{{ .Site.Title }}">
<meta property="og:locale" content="{{ .Site.LanguageCode }}">
{{- $s3 := .Site.Params.s3BaseURL -}}
{{- $imageURL := $image -}}
{{- if and $s3 (not (strings.HasPrefix $image "http")) }}
	{{- $imageURL = printf "%s/%s" $s3 (strings.TrimPrefix $image "/") -}}
{{- else }}
	{{- $imageURL = $image | absURL -}}
{{- end -}}
<meta property="og:image" content="{{ $imageURL }}">
<meta property="og:type" content="{{ if .IsHome }}website{{ else }}article{{ end }}">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ .Params.seo.twitter.title | default $title }}">
<meta name="twitter:description" content="{{ .Params.seo.twitter.description | default $description }}">
<meta name="twitter:image" content="{{ $imageURL }}">

<!-- Favicon and app icons -->
<!-- Place your favicon pack files in /icons/ (see kids/static/icons/) -->
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
<link rel="manifest" href="/icons/site.webmanifest">
<meta name="theme-color" content="{{ .Site.Params.themeColor | default "#ff6a00" }}">

<!-- Article specific -->
{{ if not .IsHome }}
<meta property="article:published_time" content="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
<meta property="article:modified_time" content="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">
{{ with .Params.tags }}<meta property="article:tags" content="{{ delimit . ", " }}">{{ end }}
{{ with .Params.categories }}<meta property="article:section" content="{{ index . 0 }}">{{ end }}
{{ end }}

<!-- Structured Data -->
{{ with .Params.structured_data }}
<script type="application/ld+json">
{{ . | safeJS }}
</script>
{{ end }}

<!-- Default site-level JSON-LD for Organization and WebSite (helps SEO crawlers detect schema.org) -->
{{- /* build a safe logo URL */ -}}
{{- $logoScratch := newScratch -}}
{{- with .Site.Params.favicon -}}
	{{- if strings.HasPrefix . "http" -}}
		{{- $logoScratch.Set "logo" . -}}
	{{- else -}}
		{{- $logoScratch.Set "logo" (printf "%s%s" $.Site.BaseURL .) -}}
	{{- end -}}
{{- end -}}
<script type="application/ld+json">
{
	"@context": "https://schema.org",
	"@graph": [
		{
			"@type": "Organization",
			"name": "{{ .Site.Title }}",
			"url": "{{ .Site.BaseURL }}",
			"logo": "{{ $logoScratch.Get "logo" }}"
		},
		{
			"@type": "WebSite",
			"url": "{{ .Site.BaseURL }}",
			"name": "{{ .Site.Title }}",
			"publisher": { "@type": "Organization", "name": "{{ .Site.Title }}" }
		}
	]
}
</script>